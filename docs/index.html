<!DOCTYPE html>
<html lang="sk-SK">
<head>
	<!-- Primary Meta Tags -->
	<title>WiFi termostat - ESP8266 / ESP32 - Webserver</title>
	<meta name="description" content="Izbový termostat navrhnutý na platforme Espressif - ESP8266 / ESP32. Termostat pre vykurovanie domácnosti s ovládaním plynového kotla.">
	<meta name="keywords" content="Termostat, digitálny, arduino ide, wemos d1 mini, nodemcu, wifi, esp8266, vykurovanie, kúrenie, webserver, socket, http, web, ip, ipv4, ds18b20, onewire, 1-wire">
	<!-- Open Graph / Facebook -->
	<meta property="og:type" content="website">
	<meta property="og:url" content="https://martinius96.github.io/WiFi-termostat/">
	<meta property="og:title" content="WiFi termostat - ESP8266 / ESP32 - Webserver">
	<meta property="og:description" content="Izbový termostat navrhnutý na platforme Espressif - ESP8266 / ESP32. Termostat pre vykurovanie domácnosti s ovládaním plynového kotla.">

	<!-- Twitter -->
	<meta property="twitter:card" content="summary_large_image">
	<meta property="twitter:url" content="https://martinius96.github.io/WiFi-termostat/">
	<meta property="twitter:title" content="WiFi termostat - ESP8266 / ESP32 - Webserver">
	<meta property="twitter:description" content="Izbový termostat navrhnutý na platforme Espressif - ESP8266 / ESP32. Termostat pre vykurovanie domácnosti s ovládaním plynového kotla.">
	
	<link rel="icon" type="image/png" href="favicon.png">
	<link rel="sitemap" type="application/xml" title="Sitemap" href="sitemap.xml" />
	<meta name="google-site-verification" content="UwZZh2EXv3iWUAi_1Z0hLxVCz6ySJ4UdY_BPoLtejwo" />    	
	<meta property='fb:admins' content='100001242570317'>
    	<meta charset="utf-8">
    	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
	<script type="text/javascript">
    		window.smartlook||(function(d) {
    			var o=smartlook=function(){ o.api.push(arguments)},h=d.getElementsByTagName('head')[0];
    			var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript';
    			c.charset='utf-8';c.src='https://rec.smartlook.com/recorder.js';h.appendChild(c);
    		})(document);
    		smartlook('init', 'db50efe9fff280a17db52b82be221240cbbd3dbe');
	</script>    
		<style>
	#right {
  position: absolute;
  right: 0px;
}
	</style>
</head>
<body>
	<div class="container">
  		<div class="row">
    			<div class="col-sm-12">
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="index.html">WiFi termostat</a>
    </div>
    <ul class="nav navbar-nav">
      	<li class="active"><a href="index.html">Prehľad</a></li>
	<li><a href="zapojenie.html">Zapojenie</a></li>      
	<li class=""><a href="spustenie.html">Spustenie WiFi termostatu</a></li>
      	<li><a href="kontakt.html">Kontakt</a></li>
<li style="float: right; "><a href="https://martinius96.github.io/termostat-ethernet/" class="btn btn-danger" role="button" title="Zmeniť projekt na Ethernet termostat"><img src="https://www.flaticon.com/svg/static/icons/svg/908/908547.svg" width=16px height=16px> <font color="white">Ethernet termostat</font></a></li>
    </ul>
  </div>
</nav>  
<div class="alert alert-success">
	<strong>Repozitár projektu so strojovými kódmi: </strong><a href="https://github.com/martinius96/WiFi-termostat/">WiFi termostat - posledný release kompilovaný z najnovšieho buildu Arduino Core 2.7.4.</a>
</div>	
<div class="alert alert-danger">
	<strong>Verzia 1.0.3 projektu WiFi termostat je posledným updatom verzie zdarma. Ďalšie chyby, bugy a bezpečnostné chyby nebudú riešené.</strong>
</div>	
<div class="alert alert-info">
	<strong>Článok k projektu na deadawp.blog.sector.sk: </strong><a href="http://deadawp.blog.sector.sk/blogclanok/13275/wifi-termostat-esp8266-1021-json-clients.htm">WiFi termostat - ESP8266 - 1.0.2.1 - JSON clients</a>
</div>	
<span class="label label-default">ESP8266</span>
<span class="label label-primary">ESP32</span>
<span class="label label-success">WiFi</span>
<span class="label label-info">DS18B20</span>
<span class="label label-warning">OneWire</span>
<span class="label label-danger">Dallas</span>
<span class="label label-default">HTML</span>
<span class="label label-primary">Webserver</span>
<span class="label label-success">WebSocket</span>
<span class="label label-info">JSON</span>
<span class="label label-warning">mDNS</span>	
<span class="label label-danger">UART</span>					
  <div class="row">
  <div class="col-sm-4"><center><img src="https://i.imgur.com/koSyFuW.png" width="128px" height="128px" style="border-radius: 50%;" alt="Riadiaci mikrokontróler NodeMCU v2 / v3 Lolin - ESP8266-12E / ESP8266-12F" title="Riadiaci mikrokontróler NodeMCU v2 / v3 Lolin - ESP8266-12E / ESP8266-12F"></center></div>
  <div class="col-sm-4"><center><img src="https://i.imgur.com/FV9xi6K.png" width="128px" height="128px" style="border-radius: 50%;" alt="Riadiaci mikrokontróler Wemos D1 Mini - ESP8266-12E / ESP8266-12F" title="Riadiaci mikrokontróler Wemos D1 Mini - ESP8266-12E / ESP8266-12F"></center></div>
  <div class="col-sm-4"><center><img src="https://i.imgur.com/BczG03b.png" width="128px" height="128px" style="border-radius: 50%;" alt="Riadiaci mikrokontróler ESP32 Devkit V1 - ESP-WROOM-32 / ESP32-S" title="Riadiaci mikrokontróler ESP32 Devkit V1 - ESP-WROOM-32 / ESP32-S"></center></div>
</div>					
<hr><center><h2>WiFi termostat - ESP8266 / ESP32</h2></center><hr>
<p style="text-align: justify;">
Programová implementácia je navrhnutá pre mikrokontrólerové platformy od výrobcu Espressif Systems. 
Konkrétne mikrokontróler ESP8266 vo verzii 12E až F využívaný v platformách Wemos D1 Mini, NodeMCU v2, v3.
<b>Mikrokontroléry ESP8266-01 / ESP8266-01S a podobné standalone čipy pred generáciou 12E nie sú kompatibilné pre projekt z hľadiska nahrávania programu, nakoľko nevyužívajú flash metódu DIO, pre ktorú sú navrhnuté volania nástroja ESPTOOL v projekte.</b>
Pre mikrokontrolér z rady ESP32 je možné využívať standalone čipy ESP-32S od AI-Thinker, ESP-WROOM32 od Espressif Systems. Ale aj DevKity obsiahnuté s týmito čipmi, sú plné kompatibilné (napríklad DevKit v1 / DevKiTC-v4).
Termostat je prístupný z LAN siete v ktorej sa nachádza, pričom je vybavený webovým rozhraním ktoré slúži na konfiguráciu všetkých prvkov termostatu.
Okrem dostupnosti termostatu na konkrétnej IP adrese je možné termostat doplniť o mDNS záznam, ktorý generuje lokálnu doménu prístupnú iba v LAN sieti v rámci tejto multicastovej služby. 
Konfigurácia termostatu na domácu LAN sieť je zabezpečená prostredníctvom WiFiManagera.
Webserver umožňuje beh niekoľkých na sebe nezávislých HTML stránok, ktoré môžu mať informatívny, alebo aj funkcionálny charakter. Webserver beží na porte 80 - HTTP.
</p>
<b>Po hardvérovej stránke projekt využíva:</b>
<li>ESP8266 / ESP32</li>
<li>Teplotný senzor DS18B20 na OneWire zbernici</li>
<li>Relé SRD-5VDC-SL-C slúžiace na spínanie kotla (Active-LOW signál)</li>
<p style="text-align: justify;">
<b>HTML stránky bežiace na platforme ESP8266:</b>
<li><b>/</b> - root stránka obsahujúca formulár, aktuálny výpis logického výstupu pre relé, teplotu</li>
<li><b>/action.html</b> - spracúvava hodnoty z formulára, zapisuje ich do EEPROM pamäte, presmeruje používateľa späť na root stránku</li>
<li><b>/get_data.json</b> - distribuuje dáta o aktuálnej teplote, referenčnej teplote a hysteréza tretej strane (počítač, mikrokontróler, iný klient...) v JSON formáte</li>
<hr>				
Elektromagnetické relé SRD-5VDC-SL-C, ktoré je v projekte použité umožňuje spínať až 10A pri 230V - výkon 2300W. 
V prípade spínania jednosmerného obvodu (záťaže) je možné spínať 300W (10A pri 30V DC). 
Prípadne je pre schému zapojenia plne kompatibilné aj SSR relé OMRON G3MB-202P, ktoré je vhodné iba pre neindukčnú záťaž a výhradne pre obvod so striedavým napätím. 
Maximálny spínaný výkon 460W (230V, 2A). <b>Termostat je možné používať celoročne. V prípade nepotrebného riadenia je možné výstup fyzicky odpojiť a termostat využívať ako WiFi teplomer pre zisk dát z miestnosti, kde sa nachádza.</b> 
Logika termostatu sa vykonáva každých 10 sekúnd nezávisle na webserveri a pripojených klientoch, nevyžaduje sa keep-alive spojenie pre jej vykonanie. 
Vždy pri vykonaní logiky vypíše na UART termostat aj informáciu o aktuálnej IP adrese, respektíve aj mDNS zázname (ak sa s mDNS firmvér používa) a dá tak používateľovi informáciu, kde v LAN sieti je termostat dosiahnuteľný so svojim webovým rozhraním.
Okrem toho vypíše aj dynamickú voľnú pamäť - HEAP, ktorá sa pohybuje na úrovni 40 až 44kB a taktiež aj aktuálny stav výstupu s oznámením zmeny (ak pretečie rozhodovací threshold do + respektíve do -).
<b>3V3 operačná logika GPIO mikrokontrolérov ESP8266 a ESP32 postačuje pre digitálny signál zmeny, relé však musí byť napájané na 5V z VUSB, respektíve VIN.</b>
</p>

<b>Webové rozhranie pre WiFi termostat umožňuje:</b>
<li>Prehliadať v reálnom čase teplotu zo senzora DS18B20, uptime zariadenia, hodnotu výstupu s dynamickou zmenou, aktuálne nastavené konfiguračné údaje pre termostat t.j. cieľovú teplotu a hysterézu</li>
<li>Modifikovať cieľovú (referenčnú) teplotu v rozsahu 5 až 50 °C s 0,25 °C krokom</li>
<li>Modifikovať hysterézu v rozsahu 0 až 10 °C s 0,25 °C krokom</li>

<b>ZAP/VYP regulácia kotla:</b> 
<li>Príklad ZAP/VYP regulácie vykurovania - <font color="red">VIZUALIZÁCIA NIE JE SÚČASŤOU PROJEKTU</font></li>	
<li>Kotol je aktívny po dobu dostiahnutia cieľovej teploty + hysterézy</li>
<li>Na vizualizácii teplôt vody je patrný tzv. dobeh vykurovania a následné chladnutie vody až do opätovnej aktivity vykurovania, kedy je nameraná teplota pod nastavenú cieľovú teplotu - hystérzu</li>		
<img src="https://i.imgur.com/IDWLuOr.png" style="display: block; max-width: 100%; height: auto;" alt="ZAP/VYP regulácia kotla s hysterézou" title="ZAP/VYP regulácia kotla s hysterézou">   

Webové rozhranie je navrhnuté pre prispôsobenie sa väčším i menším obrazovkám. Je responzívne, podporuje širokouhlé obrazovky s vysokým rozlíšením, ale aj mobilné zariadenia. 
Rozhranie využíva importované CSS štýly Bootstrap frameworku z externého CDN servera, ktorý načíta client-side zariadenie pri otvorení stránky bežiacej na ESP. 
Importovaním CSS štýlov z externého servera umožní znížiť výkonové a pamäťové zaťaženie mikrokontroléru.  
</p>
<center><img src="https://i.imgur.com/8shZ0K3.png" style="display: block; max-width: 100%; height: auto;" alt="WiFi termostat - webové rozhranie vizualizované v systéme Android - Chrome" title="WiFi termostat - webové rozhranie vizualizované v systéme Android - Chrome"></center>   		
<hr>
<p style="text-align: justify;">
Aby ostali nastavené hodnoty termostatu zachované aj po výpadku napájania, sú uložené do EEPROM pamäte ESP, ktorá je emulovaná vo flash pamäti, nakoľko platforma nemá fyzicky EEPROM čip (pamäť). 
Referenčná teplota na offset 10, hysteréza na offset 100. Každá z hodnôt zaberá maximálne 5B v EEPROM pamäti + ukončovací znak. 
Dáta sa prepisujú iba pri odoslaní HTML formulára, prevádzka termostatu je tak maximálne šetrná k EEPROM pamäti pre jej maximálnu trvácnosť. 
Stav výstupu existuje iba v RAM pamäti, neukladá sa do flash pamäte.
V prípade, že zariadenie pri prvom spustení nemá nič uložené na spomenutých EEPROM offsetoch, vykoná sa automatický zápis s predvolenými hodnotami - referencia: 20.25 °C, hysteréza 0.00 °C, tzv. fail-safe riešenie.
ESP8266 a ESP32 pre prácu s EEPROM pamäťou využíva funkcie EEPROM.put() v spojitosti s EEPROM.commit() a pre čítanie dát z EEPROM EEPROM.get(), ktoré podporujú akýkoľvek dátový typ, v našom prípade float().
</p>
<p style="text-align: justify;">
Prostredníctvom meta tagu Refresh vykonáva webserver obnovu celej stránky každých 30 sekúnd a prostredníctvom Javascriptu sa vypisuje do HTML stránky aj orientačný čas do refreshu. 
Do tohto času je potrebné stihnúť zapísať zmenu pre termostat, inak sa input okná pre číselné vstupy do formulára resetujú pri obnovení stránky. 
Nakoľko built-in knižnica Ethernet neobsahuje využitie asynchrónneho webservera (ktorý je možné využiť napríklad u mikrokontrolérov Espressif ESP8266 / ESP32), je nutné prepisovať celú stránku. 
Dynamický údaj, ktorý sa predovšetkým mení je aktuálna hodnota výstupu - <b><font color="#27AE60">Zapnutý</font></b> / <b><font color="red">Vypnutý</font></b>, ktorý informuje prevádzkovateľa o skutočnom stave výstupu spoločne aj s farebným označením. 
Nakoľko sa logika systému  vykonáva nezávisle na webserveri, do refreshu môže už byť výstup v inom stave, ako aktuálne vypísanom vo webaplikácii. Zmena výstupu je ihneď vypísaná napríklad na UART monitor.
Na webovej stránke termostatu nájde používateľ aj informácie o uptime zariadenia (ako dlho beží), t.j. čas v dňoch, hodinách, minútach a sekundách.
</p>

<b>Hlavná stránka pre modifikáciu cieľovej teploty a hysterézy - ukážka zapnutého:</b>
<div class="alert alert-info">
	<strong>Ukážkové dáta</strong>
	<li><b>Cieľová teplota:</b>  22.75 °C</li>
	<li><b>Hysteréza:</b>  0.25 °C</li>
	<li><b>Namerané dáta:</b>  21.59 °C</li>
	<li><b>Výstup:</b>  <font color="#27AE60">Zapnutý</font></li>
	<hr>
	<p style="text-align: justify;">
		Termostat vykuruje od nameranej teploty 22.49 °C a nižšej. 
		V prípade dosiahnutia teploty 23.01 °C sa výstup vypne, signalizačné relé sa rozpojí a plynový kotol prestáva kúriť. 
		Nastáva dobeh vykurovania a chladnutie miestnosti v ktorej sa vykonávajú merania. Termostat sa opäť aktivuje až pri dosiahnutí teploty 22.49 °C, alebo nižšej.	
	</p>	
</div>

<b>Hlavná stránka pre modifikáciu cieľovej teploty a hysterézy:</b>
<img src="https://i.imgur.com/YX7W2Z8.png" style="display: block; max-width: 100%; height: auto;" alt="WiFi termostat - Hlavný prehľad s modifikáciou cieľovej teploty a hysterézy - Vypnutý" title="WiFi termostat - Hlavný prehľad s modifikáciou cieľovej teploty a hysterézy - Vypnutý">        			

<b>Priebeh spracovania zadaných údajov (presmerovanie používateľa):</b>
<img src="https://i.imgur.com/ZptC0UR.png" style="display: block; max-width: 100%; height: auto;" alt="WiFi termostat - spracovanie údajov z HTML formulára" title="WiFi termostat - spracovanie údajov z HTML formulára">        			

<b>JSON výstup webservera v prehliadači / klientovi cez websocket:</b>
<center><img src="https://i.imgur.com/iqxV12k.png" style="display: block; max-width: 100%; height: auto;" alt="WiFi termostat - JSON output" title="WiFi termostat - JSON output"></center>        		

<b>Výstup do UART monitoru - logika systému + nastavená IP adresa, mDNS záznam:</b>
<center><img src="https://i.imgur.com/f1mF6Fk.png" style="display: block; max-width: 100%; height: auto;" alt="WiFi termostat - UART" title="WiFi termostat - UART"></center>        		

<b>Rozšírená verzia tohto termostatu obsahuje navyše - <font color="red">NIE JE OBSIAHNUTÁ V GITHUB REPOZITÁRI SO SKOMPILOVANÝM FIRMVÉROM:</font></b>
<div class="alert alert-info">
	<b>Pri záujme o kúpu plnej verzie projektu so zdrojovým kódom (.ino) - </b>martinius96@gmail.com
</div>
<li>Zdrojový kód (.ino)</li>
<li>Manuálny režim pre relé (neobmedzená doba, natvrdo ZAP/VYP)</li>
<li>Watchdog timer</li>
<li>Dostupné senzory SHT21, SHT31, DHT22, BME280, BMP280 a iné</li>
<li>Režim chladenia</li>
<li>PID regulácia teploty pre termostat</li>
<li>Basic OTA</li>
<li>Interakcia s Amazon Alexa Echo Dot s možnosťou hlasového ovládania termostatu</li>
<li>Možnosť Publishu dát na MQTT Broker / cez HTTP / HTTPS request na vzdialený webserver s uložením dát do MySQL databázy</li>
<hr>
<h3><font color="#C0392B">Ukážkový výpis - JSON output pre ďalších klientov, spracovanie</font></h3>
<div class="alert alert-danger">
{<br>
	"Hysteresis":0.25,<br>
	"Target_Temperature":21.75,<br>
	"Actual_Temperature":21.43<br>
}
</div>
		<hr>
<h3>JSON client - výstup do Serial monitoru, parsovanie dát, integrácia MQTT / MQTTS</h3>
<p style="text-align: justify;">
<b>Client umožňuje načítať JSON dáta, ktoré WiFi termostat distribuuje na podstránke /get_data.json</b>
Načítané JSON data dokáže klient deserializovať a vyparsovať a následne s nimi pracovať.
Dáta mikrokontróler vypíše aj na UART vrátane JSON formátu dát v akom ich prebral
Na základe vyparsovaných dát môžu byť archivované - zapísané do MySQL databázy, Loxone systému...
Taktiež je možné riadiť v domácnosti iné entity na základe týchto hodnôt (otváranie ventilov radiátorov, solenoid, vetranie, uzavretie okien atď..)
Získané hodnoty z JSON dát sú: aktuálne nastavená cieľová teplota a hysteréza, aktuálne nameraná teplota senzorom Dallas DS18B20 na OneWire zbernici
JSON client je navrhnutý pre ESP32, ESP8266 a Arduino s Ethernet shieldom / modulom Wiznet W5100 / W5500
JSON klientom existuje aj rozšírený firmvér s MQTT, respektíve MQTTS názvom.
MQTT vytvorí nešifrované spojenie s MQTT Brokrom, MQTTS šifrované. Oba typy spojení využívajú socket.
Využíva sa slovenský MQTT Broker pre vývojárov <a href="https://mqtt.iotindustries.sk/sk/">IoT Industries Slovakia</a> - možné používať zdarma.
<b>Mikrokontróler zapisuje dáta pod hlavný topic termostat do subtopicov hysteresis, actual_temp, target_temp.</b>
<b>Daný JSON MQTT klient má k daným subtopicom prihlásený Subscribe prostredníctvom čítania hlavného topicu termostat/#.</b>
<b><font color="red">Tento MQTT Broker je verejný a tak môžu byť dáta zmenené, prepísané, čítané akýkoľvek používateľom služby</font></b>
Ak do svojho mikrokontroléru nahrá firmvér JSON klienta bez zmeny, akýkoľvek iný používateľ vám dané dáta v preddefinovanom topicu prepíše
</p>
<center><img src="https://i.imgur.com/4Cm5z8o.png" style="display: block; max-width: 100%; height: auto;" alt="JSON client pre WiFi termostat - UART výstup" title="JSON client pre WiFi termostat - UART výstup"></center>       		
<center><img src="https://i.imgur.com/5BtdmFH.png" style="display: block; max-width: 100%; height: auto;" alt="JSON client MQTT Broker IoT Industries Slovakia - výstup topicu - Subscribe termostat" title="JSON client MQTT Broker IoT Industries Slovakia - výstup topicu - Subscribe termostat"></center>       		
<p style="text-align: justify;">
<b>Termostat je určený iba pre interiérové teploty!</b> (nad 0°C), čomu je prispôsobená aj logika systému! 
Termostatom je možné nahradiť už existujúci izbový termostat, možno dočasne nahradiť ohrievač v akváriu / teráriu pre udržiavanie stálej teploty.
</p>
 </div>
</div>
</div>
</body>
</html>
